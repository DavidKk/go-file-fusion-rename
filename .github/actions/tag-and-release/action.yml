name: "Tag and Release"
description: "Automatically create version tag and GitHub release"

inputs:
  github-token:
    description: "GitHub token"
    required: true
  version-bump:
    description: "Version bump type"
    required: false
    default: "patch"
  artifacts:
    description: "Comma-separated list of artifacts to include in release"
    required: true
  release-type:
    description: "Release type: auto only"
    required: false
    default: "auto"
  use-hash:
    description: "Whether to use hash for version"
    required: false
    default: "true"

outputs:
  tag:
    description: "Created tag"
    value: ${{ steps.outputs.outputs.tag }}
  changelog:
    description: "Generated changelog"
    value: ${{ steps.outputs.outputs.changelog }}
  should-release:
    description: "Whether release should proceed"
    value: ${{ steps.outputs.outputs.should_release }}

runs:
  using: "composite"
  steps:
    - name: Get commit hash
      id: hash
      shell: bash
      run: |
        echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        echo "full_sha=$GITHUB_SHA" >> $GITHUB_OUTPUT

    - name: Check existing tag
      id: existing_tag
      shell: bash
      run: |
        existing_tag=$(git tag --points-at HEAD)
        if [ -n "$existing_tag" ]; then
          echo "tag=$existing_tag" >> $GITHUB_OUTPUT
          echo "has_tag=true" >> $GITHUB_OUTPUT
        else
          echo "tag=" >> $GITHUB_OUTPUT
          echo "has_tag=false" >> $GITHUB_OUTPUT
        fi

    - name: Check version strategy
      id: version_check
      shell: bash
      run: |
        # è·å–æ‰€æœ‰æ ‡ç­¾
        git fetch --tags

        # è·å–æœ€æ–°çš„æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¸åŒ…å«alphaï¼‰
        latest_formal_tag=$(git tag -l | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)

        if [ -z "$latest_formal_tag" ]; then
          # æ²¡æœ‰ä»»ä½•æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼Œä½¿ç”¨åˆå§‹ç‰ˆæœ¬
          echo "next_version=v1.0.0" >> $GITHUB_OUTPUT
          echo "strategy=initial" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¹åº”çš„alphaç‰ˆæœ¬
          alpha_tag_exists=$(git tag -l | grep -E "^${latest_formal_tag}-alpha\\." | head -1)
          if [ -n "$alpha_tag_exists" ]; then
            # å·²æœ‰alphaç‰ˆæœ¬ï¼Œè¯´æ˜å½“å‰ç‰ˆæœ¬è¿˜æœªæ­£å¼å‘å¸ƒï¼Œä¿æŒç‰ˆæœ¬ä¸å˜
            echo "next_version=$latest_formal_tag" >> $GITHUB_OUTPUT
            echo "strategy=keep_current" >> $GITHUB_OUTPUT
          else
            # æ²¡æœ‰alphaç‰ˆæœ¬ï¼Œè¯´æ˜æœ€æ–°æ­£å¼ç‰ˆæœ¬å·²å‘å¸ƒï¼Œéœ€è¦+1
            version_without_v=${latest_formal_tag#v}
            IFS='.' read -r major minor patch <<< "$version_without_v"
            next_patch=$((patch + 1))
            next_version="v${major}.${minor}.${next_patch}"
            echo "next_version=$next_version" >> $GITHUB_OUTPUT
            echo "strategy=increment" >> $GITHUB_OUTPUT
          fi
        fi

        echo "latest_formal_tag=${latest_formal_tag:-v1.0.0}" >> $GITHUB_OUTPUT

    - name: Set outputs
      id: outputs
      shell: bash
      run: |
        if [ "${{ steps.existing_tag.outputs.has_tag }}" = "true" ]; then
          # å¦‚æœå·²æœ‰TAGï¼Œç›´æ¥ä½¿ç”¨
          version_tag="${{ steps.existing_tag.outputs.tag }}"
          changelog="Release using existing tag ${{ steps.existing_tag.outputs.tag }}"
        else
          # ä½¿ç”¨æ™ºèƒ½ç‰ˆæœ¬ç­–ç•¥
          base_version="${{ steps.version_check.outputs.next_version }}"
          version_tag="${base_version}-alpha.${{ steps.hash.outputs.short_sha }}"
          
          case "${{ steps.version_check.outputs.strategy }}" in
            "initial")
              changelog="Initial version ${base_version} (first release)"
              ;;
            "increment")
              changelog="Auto-increment to ${base_version} (previous version ${{ steps.version_check.outputs.latest_formal_tag }} was already released)"
              ;;
            "keep_current")
              changelog="Keep current version ${base_version} (no formal release yet for this version)"
              ;;
            *)
              changelog="Alpha release ${version_tag}"
              ;;
          esac
        fi

        echo "tag=${version_tag}" >> $GITHUB_OUTPUT
        echo "changelog=${changelog}" >> $GITHUB_OUTPUT
        echo "should_release=true" >> $GITHUB_OUTPUT
        echo "hash=${{ steps.hash.outputs.short_sha }}" >> $GITHUB_OUTPUT

    - name: Download artifacts
      if: steps.outputs.outputs.should_release == 'true'
      uses: actions/download-artifact@v4
      with:
        path: ./release

    - name: Create GitHub Release
      if: steps.outputs.outputs.should_release == 'true' && steps.outputs.outputs.tag != ''
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.outputs.outputs.tag }}
        name: Release ${{ steps.outputs.outputs.tag }}
        body: |
          ## ğŸš€ Release ${{ steps.outputs.outputs.tag }}

          ### ğŸ“‹ Release Info
          - **Release Type**: è‡ªåŠ¨å‘å¸ƒ (Auto)
          - **Commit Hash**: ${{ steps.outputs.outputs.hash }}
          - **Version Strategy**: å“ˆå¸Œå€¼ç‰ˆæœ¬

          ### âœ¨ What's New
          ${{ steps.outputs.outputs.changelog }}

          ### ğŸ“¦ Downloads
          - **Linux**: file-fusion-rename-linux
          - **Windows**: file-fusion-rename-windows.exe  
          - **macOS (Intel)**: file-fusion-rename-macos-intel
          - **macOS (Apple Silicon)**: file-fusion-rename-macos-arm64

          ### ğŸ”§ Installation
          1. Download the appropriate binary for your platform
          2. Make it executable (Linux/macOS): `chmod +x file-fusion-rename-*`
          3. Run the application

          ### ğŸ“ Changelog
          For detailed changes, see the commit history.
        files: |
          ./release/file-fusion-rename-linux/file-fusion-rename-linux
          ./release/file-fusion-rename-windows/file-fusion-rename-windows.exe
          ./release/file-fusion-rename-macos-intel/file-fusion-rename-macos-intel
          ./release/file-fusion-rename-macos-arm64/file-fusion-rename-macos-arm64
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
